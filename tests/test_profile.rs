use crate::utils::{SESSION, Store};
use crunchyroll_rs::Locale;
use crunchyroll_rs::crunchyroll::MaturityRating;
use crunchyroll_rs::profile::{Profiles, UpdateProfilePreferences};
use rand::Rng;
use rand::distr::Alphanumeric;
use std::env;

mod utils;

static PROFILES: Store<Profiles> = Store::new(|| {
    Box::pin(async {
        let crunchy = SESSION.get().await?;
        let profiles = crunchy.profiles().await?;
        Ok(profiles)
    })
});

#[tokio::test]
async fn profiles() {
    assert_result!(PROFILES.get().await)
}

#[tokio::test]
async fn modify_profile() {
    let profiles = PROFILES.get().await.unwrap();

    let new_profile = profiles
        .new_profile(
            rand::rng()
                .sample_iter(&Alphanumeric)
                .take(16)
                .map(char::from)
                .collect(),
            rand::rng()
                .sample_iter(&Alphanumeric)
                .take(16)
                .map(char::from)
                .collect(),
        )
        .await;
    assert_result!(new_profile);

    let mut profile = new_profile.unwrap();

    assert_result!(
        profile
            .change_profile_name(
                rand::rng()
                    .sample_iter(&Alphanumeric)
                    .take(16)
                    .map(char::from)
                    .collect()
            )
            .await
    );

    let preferences = UpdateProfilePreferences::default()
        .audio_language(Locale::en_US)
        .subtitle_language(Locale::en_US);
    assert_result!(profile.update_preferences(preferences.clone()).await);

    if let Ok(password) = env::var("PASSWORD") {
        assert_result!(
            profile
                .update_maturity_rating(MaturityRating::NotMature, password.clone())
                .await
        )
    }

    assert_result!(profile.clone().delete().await)
}
